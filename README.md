# echoes-compress

Service to compress daily folders generated by Echoes

### Documentation

1. [General Info](#general-info)
2. [Configuration](#configutation)
3. [Use](##use)
4. [Testing](#testing)

#### General Info

This service is meant to compress (and delete) data generated by Echoes.

Echoes generates a daily folder with a name following `YYYY-mm-dd` pattern. Inside this folder, there are several other folders and files in turn, with a tree similar to this:

```sh
/gnuplot/specs/fakes
/gnuplot/specs/overdense
/gnuplot/specs
/gnuplot/specs/underdense
/screenshots/fakes
/screenshots/overdense
/screenshots/underdense
/stats
```

The daily folder can be several Gbs size.

This service will perform a initial compression when started. Then, it will run a `cron` job every day, getting the `YYYY-mm-dd` pattern and compresing the folder. As a second (and optional) step, the original folder can be deleted after the compression.

#### Configuration

You need to provide the following env vars:

- `ALLOW_DELETE`: Set this var to `active` value when you want the service to remove the original folder after the compression
- `CRON_SCHEDULE`: Set this var to a `cron` expression. E.g `0 0 10 * * *` to execute the service everyday at 10:00. [More info](https://www.npmjs.com/package/cron#cron-ranges)

This service includes a `docker-compose` file with these two env vars. It also includes a `volume` with the host path to the `YYYY-mm-dd` folders, mapped to `/echoes`. You need to set the correct path

```yml
volumes:
      - /path/to/host/dir:/echoes
```

If you run the service **locally**, you need to change the value of that path in `config/default.js`

```js
 compressor: {
    localPath: '/echoes', // change to /path/to/host/dir
  },
```

#### Use

##### Local

You need to install [Node.js](https://nodejs.org/en/download/) in your machine to run the app locally. Then, execute:

```sh
npm i
```

and

```sh
npm start
```


##### Docker

You need to have [Docker](https://docs.docker.com/get-docker/) installed in your machine.

If you have Node.js, you may execute this npm script:

```sh
npm run prod:up
```

Or run the docker container:

```sh
docker-compose --file docker-compose.yml --project-name echoes-compress up -d --force-recreate --build
```

#### Testing

Install dependencies:
```sh
npm i
```

Execute tests:
```sh
npm t
```

